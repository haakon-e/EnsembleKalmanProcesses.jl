<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Cloudy Example · EnsembleKalmanProcesses.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">EnsembleKalmanProcesses.jl</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../installation_instructions/">Installation instructions</a></li><li><a class="tocitem" href="../../parameter_distributions/">Prior distributions</a></li><li><a class="tocitem" href="../../observations/">Observations</a></li><li><a class="tocitem" href="../../ensemble_kalman_inversion/">Ensemble Kalman Inversion</a></li><li><a class="tocitem" href="../../ensemble_kalman_sampler/">Ensemble Kalman Sampler</a></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox" checked/><label class="tocitem" for="menuitem-7"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../template_example/">Template Example</a></li><li class="is-active"><a class="tocitem" href>Cloudy Example</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-8" type="checkbox"/><label class="tocitem" for="menuitem-8"><span class="docs-label">API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../API/EnsembleKalmanProcessModule/">EnsembleKalmanProcessModule</a></li><li><a class="tocitem" href="../../API/ParameterDistribution/">ParameterDistribution</a></li><li><a class="tocitem" href="../../API/Observations/">Observations</a></li><li><a class="tocitem" href="../../API/DataStorage/">DataStorage</a></li></ul></li><li><a class="tocitem" href="../../glossary/">Glossary</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Cloudy Example</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Cloudy Example</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/EnsembleKalmanProcesses.jl/blob/master/docs/src/examples/Cloudy_example.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Cloudy-Example"><a class="docs-heading-anchor" href="#Cloudy-Example">Cloudy Example</a><a id="Cloudy-Example-1"></a><a class="docs-heading-anchor-permalink" href="#Cloudy-Example" title="Permalink"></a></h1><h3 id="What-Is-This-Example-About?"><a class="docs-heading-anchor" href="#What-Is-This-Example-About?">What Is This Example About?</a><a id="What-Is-This-Example-About?-1"></a><a class="docs-heading-anchor-permalink" href="#What-Is-This-Example-About?" title="Permalink"></a></h3><p>This example is based on Cloudy, a microphysics model that simulates how cloud droplets collide and coalesce into larger drops. Collision-coalescence is a crucial process for the formation of rain. </p><p>Cloudy takes two inputs: The initial mass distribution of the cloud droplets, and a so-called collision-coalescence kernel, which specifies the probability that two droplets of masses x and y collide and coalesce in a given time interval.  Cloudy simulates the evolution of the initial cloud droplet mass distribution over time, as more and more droplets combine into bigger drops. It does this not by simulating each individual droplet, but by using a &quot;bulk approach&quot;, which only keeps track of some number of moments of the cloud droplet mass distribution.</p><p>This example shows how Ensemble Kalman methods can be used to learn the parameter of the initial cloud droplet mass distribution from observations of the moments of that mass distribution at a later time. The collision-coalescence kernel is assumed to be known, but one could also learn the parameters of the kernel instead of the parameters of the droplet distribution (or both).</p><p>Cloudy is used here in a &quot;perfect model&quot; (aka &quot;known truth&quot;) setting, which means that the &quot;observations&quot; are generated by Cloudy itself, by running it with the true parameter values. In more realistic applications, the observations will come from some external measurement system.</p><p>For more information on Cloudy, see <a href="https://github.com/CliMA/Cloudy.jl.git">here</a>.</p><h3 id="Prerequisites"><a class="docs-heading-anchor" href="#Prerequisites">Prerequisites</a><a id="Prerequisites-1"></a><a class="docs-heading-anchor-permalink" href="#Prerequisites" title="Permalink"></a></h3><p>In order to run this example, you need to install <code>Cloudy.jl</code> (the &quot;#master&quot; lets you install the current master branch):</p><pre><code class="language-none">pkg &gt; add Cloudy#master</code></pre><h3 id="Structure"><a class="docs-heading-anchor" href="#Structure">Structure</a><a id="Structure-1"></a><a class="docs-heading-anchor-permalink" href="#Structure" title="Permalink"></a></h3><p>The file <code>DynamicalModel.jl</code> provides the functionality to run Cloudy, i.e., to map the parameters of the initial cloud droplet mass distribution to the (zeroth-, first-, and second-order) moments of the distribution at a specified end time. In this example, there is no post-processing required to produce the observations from the model output (i.e., the observation map <span>$\mathcal{H}$</span> mentioned in the <a href="https://clima.github.io/EnsembleKalmanProcesses.jl/dev/ensemble_kalman_inversion/">docs</a> is the identity map).</p><p>The file <code>Cloudy_example_eki.jl</code> sets up the inverse problem and solves it using <a href="https://clima.github.io/EnsembleKalmanProcesses.jl/dev/ensemble_kalman_inversion/">Ensemble Kalman inversion</a>, and the file <code>Cloudy_example_uki.jl</code> does the same using unscented Kalman inversion.</p><h3 id="Inverse-Problem"><a class="docs-heading-anchor" href="#Inverse-Problem">Inverse Problem</a><a id="Inverse-Problem-1"></a><a class="docs-heading-anchor-permalink" href="#Inverse-Problem" title="Permalink"></a></h3><p>The assumed functional form of the cloud droplet mass distribution <span>$f(x, t)$</span> (where <span>$x$</span> is the droplet mass and <span>$t$</span> is time) is a <span>$Gamma(k_t, \theta_t)$</span> distribution, scaled by a factor <span>$N_{0,t}$</span> which denotes the droplet number concentration:</p><p class="math-container">\[f(x, t) = \frac{N_{0,t}}{\Gamma(k_t)\theta_t^k} x^{k_t-1} \exp{(-x/\theta_t)}\]</p><p>The parameter vector <span>$\phi_t= [N_{0,t}, k_t, \theta_t]$</span> changes over time (as indicated by the subscript <span>$t$</span>), as the shape of the distribution evolves. In fact, there is a priori no reason to assume that the distribution would retain its Gamma shape over time, but this is a common assumption that is made in order to solve the closure problem (generally, the prognostic moments depend on higher-order moments which can only be calculated when an assumption is made on the type of distribution giving rise to those moments).</p><p>The goal is to learn the parameters at time <span>$t = 0$</span>, <span>$\phi_0 = [N_{0,0}, k_0, \theta_0]$</span>, from observations <span>$y$</span> of the zeroth-, first-, and second-order moments of the distribution at time <span>$t_{end} &gt; 0$</span>. All three parameters have to be strictly positive, so we put lower bounds on them and use a log transformation <span>$\mathcal{T}$</span> to map the parameter <span>$\phi$</span> to a parameter <span>$\theta$</span> (i.e., <span>$\mathcal{T}(\phi) = \theta$</span>), which lives in an unconstrained space. The ensemble Kalman algorithm is then performed in this unconstrained &quot;<span>$\theta$</span>-space&quot; (note: don&#39;t confuse the parameter vector <span>$\theta$</span> with the <span>$\theta_t$</span> parameter of the Gamma distribution).</p><p>The data <span>$y$</span> and parameter vector <span>$\theta$</span> are assumed to be related according to:</p><p class="math-container">\[    y = \mathcal{G}(\theta) + \eta,\]</p><p>where <span>$\mathcal{G}:  \mathbb{R}^3 \rightarrow \mathbb{R}^3$</span> denotes the  forward map, which is composed of the dynamical model <span>$\Psi$</span> (here: Cloudy)  and the inverse transformation <span>$\mathcal{T}^{-1}$</span>: <span>$\mathcal{G} = \Psi  \circ \mathcal{T}^{-1}$</span>. </p><p><span>$y \in \mathbb{R}^3$</span> is the vector of observations,  and <span>$\eta$</span> is the observational noise, which is assumed to be drawn from a  3-dimensional  Gaussian with distribution <span>$\mathcal{N}(0, \Gamma_y)$</span>.</p><p>In a perfect model setting, the &quot;observational noise&quot; represents the internal model variability. Since Cloudy is a purely deterministic model, there is no straightforward way of coming up with a covariance <span>$\Gamma_y$</span> for this internal noise. We decide to use a diagonal covariance, with entries (variances) largely proportional to <span>$\mathcal{G}(\theta_{true})$</span>, where <span>$\theta_{true}$</span> is the true distribution parameter vector (in unconstrained space).</p><h3 id="Running-the-Example"><a class="docs-heading-anchor" href="#Running-the-Example">Running the Example</a><a id="Running-the-Example-1"></a><a class="docs-heading-anchor-permalink" href="#Running-the-Example" title="Permalink"></a></h3><p>Once Cloudy is installed, the examples can be run from the julia REPL:</p><pre><code class="language-julia"># Solve inverse problem using ensemble Kalman inversion
include(&quot;Cloudy_example_eki.jl&quot;)</code></pre><p>or</p><pre><code class="language-julia"># Solve inverse problem using unscented Kalman inversion
include(&quot;Cloudy_example_uki.jl&quot;)</code></pre><h3 id="Solution-and-Output"><a class="docs-heading-anchor" href="#Solution-and-Output">Solution and Output</a><a id="Solution-and-Output-1"></a><a class="docs-heading-anchor-permalink" href="#Solution-and-Output" title="Permalink"></a></h3><ul><li><p><code>Cloudy_example_eki.jl</code>: The optimal parameter vector determined by the ensemble Kalman inversion is the ensemble mean of the particles after the last iteration, which is printed to standard output. An output directory is created, where two files are stored: <code>parameter_storage_eki.jld2</code> and <code>data_storage_eki.jld2</code>, which contain all parameters and model output from the ensemble Kalman iterations, respectively (both as <code>DataStorage.DataContainer</code> objects). In addition, an animation is produced that shows the evolution of the ensemble of particles over subsequent iterations of the optimization.</p></li><li><p><code>Cloudy_example_uki.jl</code>: In addition to a point estimate of the optimal parameter (which is again given by the ensemble mean of the last iteration and printed to standard output), Unscented Kalman inversion also provides a covariance approximation of the posterior distribution. Together, the mean and covariance allow for the reconstruction of a Gaussian approximation of the posterior distribution. The evolution of this Gaussian approximation over subsequent iterations is shown as an animation. All parameters as well as the model output from the unscented Kalman inversion are stored in an output directory, as <code>parameter_storage_uki.jld2</code> and <code>data_storage_uki.jld2</code>.</p></li></ul><h3 id="Playing-Around"><a class="docs-heading-anchor" href="#Playing-Around">Playing Around</a><a id="Playing-Around-1"></a><a class="docs-heading-anchor-permalink" href="#Playing-Around" title="Permalink"></a></h3><p>If you want to play around with the Cloudy examples, you can e.g. change the type or the parameters of the initial cloud droplet mass distribution (see <code>Cloudy.ParticleDistributions</code> for the available distributions), by modifying these lines:</p><pre><code class="language-julia">ϕ_true = [N0_true, θ_true, k_true]
dist_true = ParticleDistributions.GammaPrimitiveParticleDistribution(ϕ_true...)</code></pre><p>(Don&#39;t forget to also change <code>dist_type</code> accordingly).</p><p>You can also experiment with different noise covariances (<code>Γy</code>), priors, vary the number of iterations (<code>N_iter</code>) or ensemble particles (<code>N_ens</code>), etc.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../template_example/">« Template Example</a><a class="docs-footer-nextpage" href="../../API/EnsembleKalmanProcessModule/">EnsembleKalmanProcessModule »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Tuesday 18 May 2021 19:42">Tuesday 18 May 2021</span>. Using Julia version 1.5.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
