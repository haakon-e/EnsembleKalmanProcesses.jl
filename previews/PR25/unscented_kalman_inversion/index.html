<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Unscented Kalman Inversion · EnsembleKalmanProcesses.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">EnsembleKalmanProcesses.jl</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation_instructions/">Installation instructions</a></li><li><a class="tocitem" href="../parameter_distributions/">Prior distributions</a></li><li><a class="tocitem" href="../observations/">Observations</a></li><li><a class="tocitem" href="../ensemble_kalman_inversion/">Ensemble Kalman Inversion</a></li><li><a class="tocitem" href="../ensemble_kalman_sampler/">Ensemble Kalman Sampler</a></li><li class="is-active"><a class="tocitem" href>Unscented Kalman Inversion</a><ul class="internal"><li><a class="tocitem" href="#Algorithm"><span>Algorithm</span></a></li><li><a class="tocitem" href="#Free-parameters"><span>Free parameters</span></a></li><li><a class="tocitem" href="#Implementation"><span>Implementation</span></a></li></ul></li><li><input class="collapse-toggle" id="menuitem-8" type="checkbox"/><label class="tocitem" for="menuitem-8"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../examples/template_example/">Template example</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-9" type="checkbox"/><label class="tocitem" for="menuitem-9"><span class="docs-label">API</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../API/EnsembleKalmanProcessModule/">EnsembleKalmanProcessModule</a></li><li><a class="tocitem" href="../API/ParameterDistribution/">ParameterDistribution</a></li><li><a class="tocitem" href="../API/Observations/">Observations</a></li><li><a class="tocitem" href="../API/DataStorage/">DataStorage</a></li></ul></li><li><a class="tocitem" href="../glossary/">Glossary</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Unscented Kalman Inversion</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Unscented Kalman Inversion</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/EnsembleKalmanProcesses.jl/blob/master/docs/src/unscented_kalman_inversion.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Unscented-Kalman-Inversion"><a class="docs-heading-anchor" href="#Unscented-Kalman-Inversion">Unscented Kalman Inversion</a><a id="Unscented-Kalman-Inversion-1"></a><a class="docs-heading-anchor-permalink" href="#Unscented-Kalman-Inversion" title="Permalink"></a></h1><p>One of the ensemble Kalman processes implemented in <code>EnsembleKalmanProcesses.jl</code> is the unscented Kalman inversion (<a href="https://arxiv.org/abs/2102.01580">Huang et al, 2021</a>). The unscented Kalman inversion (UKI) is a derivative-free ensemble optimization method that seeks to find the optimal parameters <span>$\theta \in \mathbb{R}^p$</span> in the inverse problem</p><p class="math-container">\[ y = \mathcal{G}(\theta) + \eta\]</p><p>where <span>$\mathcal{G}$</span> denotes the forward map, <span>$y \in \mathbb{R}^d$</span> is the vector of observations and <span>$\eta \sim \mathcal{N}(0, \Gamma_y)$</span> is additive Gaussian observational noise. Note that <span>$p$</span> is the size of the parameter vector <span>$\theta$</span> and <span>$d$</span> is taken to be the size of the observation vector <span>$y$</span>. It is favorable for the following reasons</p><ul><li>Uncertainty quantification: gives both mean and covariance approximation of the posterior distribution, the 3-sigma confidence interval covers the truth parameters for perfect models;</li><li>Efficiency: requires only <span>$2p + 1$</span> particles in general</li><li>Robust: no empirical variance inflation or early stopping needed and no ensemble collapse</li></ul><h2 id="Algorithm"><a class="docs-heading-anchor" href="#Algorithm">Algorithm</a><a id="Algorithm-1"></a><a class="docs-heading-anchor-permalink" href="#Algorithm" title="Permalink"></a></h2><p>The UKI applies unscented Kalman filter for the following stochastic dynamical system </p><p class="math-container">\[\begin{aligned}
  &amp;\textrm{evolution:}    &amp;&amp;\theta_{n+1} = r + \alpha (\theta_{n}  - r) +  \omega_{n+1}, &amp;&amp;\omega_{n+1} \sim \mathcal{N}(0,\Sigma_{\omega}),\\
  &amp;\textrm{observation:}  &amp;&amp;y_{n+1} = \mathcal{G}(\theta_{n+1}) + \nu_{n+1}, &amp;&amp;\nu_{n+1} \sim \mathcal{N}(0,\Sigma_{\nu}).
\end{aligned}\]</p><p>Therefore, the UKI updates both the mean <span>$m_n$</span> and covariance <span>$C_n$</span> estimations of the parameter vector <span>$\theta$</span> as following</p><ul><li>Prediction step :</li></ul><p class="math-container">\[\begin{aligned}
    \hat{m}_{n+1} = &amp; r+\alpha(m_n-r)\\
    \hat{C}_{n+1} = &amp; \alpha^2 C_{n} + \Sigma_{\omega}
\end{aligned}\]</p><ul><li>Generate sigma points :</li></ul><p class="math-container">\[\begin{aligned}
    &amp;\hat{\theta}_{n+1}^0 = \hat{m}_{n+1} \\
    &amp;\hat{\theta}_{n+1}^j = \hat{m}_{n+1} + c_j [\sqrt{\hat{C}_{n+1}}]_j \quad (1\leq j\leq N_\theta)\\ 
    &amp;\hat{\theta}_{n+1}^{j+N_\theta} = \hat{m}_{n+1} - c_j [\sqrt{\hat{C}_{n+1}}]_j\quad (1\leq j\leq N_\theta)
\end{aligned}\]</p><ul><li>Analysis step :</li></ul><p class="math-container">\[   \begin{aligned}
        &amp;\hat{y}^j_{n+1} = \mathcal{G}(\hat{\theta}^j_{n+1}) \qquad \hat{y}_{n+1} = \hat{y}^0_{n+1}\\
         &amp;\hat{C}^{\theta p}_{n+1} = \sum_{j=1}^{2N_\theta}W_j^{c}
        (\hat{\theta}^j_{n+1} - \hat{m}_{n+1} )(\hat{y}^j_{n+1} - \hat{y}_{n+1})^T \\
        &amp;\hat{C}^{pp}_{n+1} = \sum_{j=1}^{2N_\theta}W_j^{c}
        (\hat{y}^j_{n+1} - \hat{y}_{n+1} )(\hat{y}^j_{n+1} - \hat{y}_{n+1})^T + \Sigma_{\nu}\\
        &amp;m_{n+1} = \hat{m}_{n+1} + \hat{C}^{\theta p}_{n+1}(\hat{C}^{pp}_{n+1})^{-1}(y - \hat{y}_{n+1})\\
        &amp;C_{n+1} = \hat{C}_{n+1} - \hat{C}^{\theta p}_{n+1}(\hat{C}^{pp}_{n+1})^{-1}{\hat{C}^{\theta p}_{n+1}}{}^{T}\\
    \end{aligned}\]</p><p>The unscented transformation parameters are</p><p class="math-container">\[    \begin{aligned}
    &amp;c_j = \sqrt{N_\theta +\lambda} \qquad W_j^{c} = \frac{1}{2(N_\theta+\lambda)}~(j=1,\cdots,2N_{\theta}).\\
    &amp;\lambda = a^2 (N_\theta + \kappa) - N_\theta \quad a=\min\{\sqrt{\frac{4}{N_\theta + \kappa}},  1\}\quad  \kappa = 0\\
    \end{aligned}\]</p><p>And <span>$[\sqrt{C}]_j$</span> is the <span>$j$</span>th column of the Cholesky factor of <span>$C$</span>. </p><p>For typical applications, a near-optimal solution <span>$\theta$</span> can be found after as few as 10 iterations of the algorithm, and no covariance inflation or early stopping is needed. The ensemble will not collapse, and therefore, the covariance estimation represents the uncertainty of the problem.</p><h2 id="Free-parameters"><a class="docs-heading-anchor" href="#Free-parameters">Free parameters</a><a id="Free-parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Free-parameters" title="Permalink"></a></h2><p>The free parameters in the unscented Kalman inversion are <span>$\alpha, r, \Sigma_{\nu}, \Sigma_{\omega}$</span></p><p>They are chosen based on theorems developed in <a href="https://arxiv.org/abs/2102.01580">Huang et al, 2021</a></p><ul><li><p>the vector <span>$r$</span> is generally set to be the prior mean</p></li><li><p>the scalar <span>$\alpha \in (0,1]$</span> is a regularization parameter, which is used to overcome ill-posedness and overfitting. A practical guide is </p><ul><li>When the observation noise is negligible, and there are more observations than parameters (identifiable inverse problem) <span>$\alpha = 1$</span> (no regularization)</li><li>Otherwise <span>$\alpha &lt; 1$</span>. The smaller <span>$\alpha$</span> is, the closer UKI will converge to the prior mean.</li></ul></li><li><p>the matrix <span>$\Sigma_{\nu}$</span> is the artificial observation errror covariance. We choose <span>$\Sigma_{\nu} = 2 \Sigma_{\eta}$</span>, which makes the inverse problem consistent. </p></li><li><p>the matrix <span>$\Sigma_{\omega}$</span> is the artificial evolution errror covariance. We choose <span>$\Sigma_{\omega} = (2 - \alpha^2)\Lambda$</span></p></li><li><p>when there are more observations than parameters (identifiable inverse problem), <span>$\Lambda = C_n$</span>, which is updated as the estimated covariance <span>$C_n$</span> in the <span>$n$</span>-thevery iteration . This guarantees the converged covariance matrix is a good approximation to the posterior covariance matrix with an uninformative prior.</p></li><li><p>otherwise <span>$\Lambda = C_0$</span>, this allows that the converged covariance matrix is a weighted average between the posterior covariance matrix with an uninformative prior and <span>$C_0$</span>.</p></li></ul><p>In a nutshell, users only need to change the <span>$\alpha$</span> (<code>α_reg</code>), and the freqency to update the <span>$\Lambda$</span> (<code>update_freq</code>).</p><h2 id="Implementation"><a class="docs-heading-anchor" href="#Implementation">Implementation</a><a id="Implementation-1"></a><a class="docs-heading-anchor-permalink" href="#Implementation" title="Permalink"></a></h2><h3 id="Initialization"><a class="docs-heading-anchor" href="#Initialization">Initialization</a><a id="Initialization-1"></a><a class="docs-heading-anchor-permalink" href="#Initialization" title="Permalink"></a></h3><p>An unscented Kalman inversion object can be created using the <code>EnsembleKalmanProcess</code> constructor by specifying the <code>Unscented()</code> process type.</p><p>Creating an ensemble Kalman inversion object requires as arguments:</p><ol><li>The mean value of the observed outputs, a vector of size <code>[d]</code>;</li><li>The covariance of the observational noise, a matrix of size <code>[d × d]</code>;</li><li>The <code>Unscented()</code> process type.</li></ol><p>The initialization of the <code>Unscented()</code> process requires prior mean and prior covariance, and the the size of the observation <code>d</code>. And user defined hyperparameters  <code>α_reg</code> and <code>update_freq</code>.</p><pre><code class="language-julia">using EnsembleKalmanProcesses.EnsembleKalmanProcessModule
using EnsembleKalmanProcesses.ParameterDistributionStorage


# need to choose regularization factor α ∈ (0,1],  
# when you have enough observation data α=1: no regularization
α_reg =  1.0
# update_freq 1 : approximate posterior covariance matrix with an uninformative prior
#             0 : weighted average between posterior covariance matrix with an uninformative prior and prior
update_freq = 1

process = Unscented(prior_mean, prior_cov, length(truth_sample), α_reg, update_freq)
ukiobj = EnsembleKalmanProcessModule.EnsembleKalmanProcess(truth_sample, truth.obs_noise_cov, process)
</code></pre><p>Note that no information about the forward map is necessary to initialize the Inversion process. The only forward map information required by the inversion process consists of model evaluations at the ensemble elements, necessary to update the ensemble.</p><h3 id="Updating-the-Ensemble"><a class="docs-heading-anchor" href="#Updating-the-Ensemble">Updating the Ensemble</a><a id="Updating-the-Ensemble-1"></a><a class="docs-heading-anchor-permalink" href="#Updating-the-Ensemble" title="Permalink"></a></h3><p>Once the unscented Kalman inversion object <code>UKIobj</code> has been initialized, any number of updates can be performed using the inversion algorithm.</p><p>A call to the inversion algorithm can be performed with the <code>update_ensemble!</code> function. This function takes as arguments the <code>UKIobj</code> and the evaluations of the forward map at each element of the current ensemble. The <code>update_ensemble!</code> function then stores the new updated ensemble and the inputted forward map evaluations in <code>UKIobj</code>.</p><p>The forward map <span>$\mathcal{G}$</span> maps the space of unconstrained parameters <span>$\theta$</span> to the outputs <span>$y\in \mathbb{R}^d$</span>. In practice, the user may not have access to such a map directly. And the map is a composition of several functions. The <code>update_ensemble!</code> uses only the evalutaions <code>g_ens</code> but not the forward map  </p><pre><code class="language-julia">N_iter = 20 # Number of steps of the algorithm


for i in 1:N_iter

    params_i = get_u_final(ukiobj); dims=1)

    # define black box parameter to observation map, 
    # with certain parameter transformation related to imposing some constraints
    # i.e. θ -&gt; e^θ  -&gt; G(e^θ) = y
    g_ens = g_ens = GModel.run_G_ensemble(params_i, lorenz_settings_G)
    # analysis step 
    EnsembleKalmanProcessModule.update_ensemble!(ukiobj, g_ens) 
end</code></pre><p>There are two examples <a href="../../../examples/Lorenz/Lorenz_example_ukp.jl">Lorenz96</a> and <a href="../../../examples/Cloudy/Cloudy_example_ukp.jl">Cloudy</a></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../ensemble_kalman_sampler/">« Ensemble Kalman Sampler</a><a class="docs-footer-nextpage" href="../examples/template_example/">Template example »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Tuesday 18 May 2021 01:58">Tuesday 18 May 2021</span>. Using Julia version 1.5.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
